# setup-ansible-for-windows

Set up ansible for windows _Install Ansible_ apt-get install software-properties-common apt-add-repository ppa:ansible/ansible apt-get update apt-get install ansible sudo pip install [http://github.com/diyan/pywinrm/archive/master.zip\#egg=pywinrm](http://github.com/diyan/pywinrm/archive/master.zip#egg=pywinrm)

Configure WinRM On Windows 2008 R2 Guest The configuration of Windows managed guests WinRM is automated and available in this powershell script . Create A Working Space Test Your Connectivity Ansible is file based, so here I create a folder underneath my home directory to store my lab configuration `mkdir -p /home//ansible_test/group_vars` We then create a file for holding hosts in lab and begin editing it `vi /home//ansible_test/host` Add the contents of this in the following format, adding extra lines with extra IPs as needed ````[windows] ``` We then create a file for holding WinRM connectivity hosts in lab and begin editing it```` vi /home//ansible\_test/group\_vars/windows.yml `Add the contents of this in the following format, adding extra lines with username and password as needed # it is suggested that these be encrypted with ansible-vault:` \# ansible-vault edit group\_vars/windows.yml ansible\_ssh\_user: ansible\_ssh\_pass: ansible\_ssh\_port: 5986 ansible\_connection: winrm `Once we have these two files setup, we can look to test connectivity` cd /home/dcauldwell/ansible\_test ansible windows -i host -m win\_ping `Debugging is not enabled by default, you might want to append -vvvvv to enable this if you have issue on first connect. If you still have issues you can test connectivity using cURL` curl -vk -d “” -u “user:pass” [https://:5986/wsman”](https://:5986/wsman”) `When you havethe win_ping module working, you can look at running the other modules shipped with the core product a full list can be found here. Maybe you might gather the Ansible facts using. ansible -m setup Create A Custom Powershell Module On looking at the core modules you might think your a bit limited but its easy to wrapper your existing Powershell logic as an Ansible module. I decided to keep all my custom modules in the lab in there own folder and change the module path.` mkdir -p /home//ansible\_test/group\_vars/library export ANSIBLE\_LIBRARY=/home//ansible\_test/library/ \` An Ansible Powershell module is made up of two files, one is the ps1 with the script contents and one is py which has description and examples. The main difference appears to be to get the Powershell console output back to Ansible you need to form as object and convert that object to JSON. It also appears not required but good practice to set an object to be returned with a changed flag to true or false unsure but believe this logic might be used at runtime to decide whether to call the handler. An easy way to create a new module, is to copy an existing one and rename it this way you get the supporting text and structure. cp /usr/share/pyshared/ansible/modules/core/windows/win\_ping\* ~/ansible\_test/library/ mv ~/ansible\_test/library/win\_ping.ps1 ~/ansible\_test/library/.ps1 mv ~/ansible\_test/library/win\_ping.py ~/ansible\_test/library/.py

A simple example use case might be if you wanted to call the Get-Host cmdlet to gather Powershell version your ps1 might read. \#!powershell \# WANT\_JSON \# POWERSHELL\_COMMON $data = Get-Host \| Select Version $result = New-Object psobject @{ get\_host\_version = $data changed = $false }; Exit-Json $result;

Using the same example your py might read DOCUMENTATION = ‘’’ — module: get\_host version\_added: “0.1” short\_description: Call Get-Host cmdlet. description: - Call Get-Host cmdlet ‘’’ EXAMPLES = ‘’’ \# Test connectivity to a windows host ansible winserver -m get\_host \# Example from an Ansible Playbook - action: get\_host ’’’

Once we have these two module files, we can look to test the new module cd /home/dcauldwell/ansible\_test ansible windows -i host -m get\_host If its working you should get returned the output from Get-Host command

dcauldwell@ansible-server:~/ansible\_test$ ansible windows -i host -m get\_host 192.128.0.60 \| success &gt;&gt; { “changed”: false, “get\_host\_version”: { “Version”: { “Build”: -1, “Major”: 4, “MajorRevision”: -1, “Minor”: 0, “MinorRevision”: -1, “Revision”: -1 } }

With this technique you should be able to form some simple modules.

